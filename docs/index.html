<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estacionamento SMAMUS 3D</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h2 {
      margin: 20px 0 10px;
      text-align: center;
      color: #333;
    }
    #contador { margin-bottom: 15px; font-weight: bold; color: #555; }
    
    #renderCanvas {
      width: 100%;
      height: 70vh;
      max-width: 900px;
      border: 2px solid #333;
      border-radius: 10px;
      outline: none;
      touch-action: none;
    }
    
    #admin-access-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
    .admin-buttons-centered {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
      width: 100%;
      max-width: 900px;
    }
    .button-style {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      color: white;
      background-color: #3CB371;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .button-style:hover {
      background-color: #008000;
      transform: translateY(-2px);
    }
    .hidden { display: none !important; }
    .legenda {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      text-align: center;
    }
    .legenda-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .legenda-icon {
      width: 24px;
      height: 24px;
      border-radius: 5px;
      border: 1px solid #000;
      background-size: cover;
      background-position: center;
    }
    .livre { background-color: rgba(0, 200, 0, 0.5); }
    .ocupada { background-color: rgba(200,0,0,0.7); }
    .especial-livre { background-color: rgba(0, 0, 200, 0.5); }
    .especial-ocupada { background-color: #d3d3d3; }
    
    #loading-screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #333;
      font-size: 18px;
    }
    
    @media (max-width: 600px) {
      .legenda { flex-direction: column; gap: 10px; }
      #admin-access-container { position: static; margin-top: 10px; margin-bottom: 10px; text-align: center; }
      .admin-buttons-centered { margin-bottom: 10px; }
      .button-style { font-size: 12px; padding: 6px 8px; }
      #renderCanvas { height: 50vh; }
    }
  </style>
</head>
<body>
  <h2>Estacionamento SMAMUS 3D</h2>
  <div id="contador">Total: 0 | Ocupadas: 0 | Livres: 0</div>
  <div id="admin-access-container">
    <button id="admin-mode-btn" class="button-style">Modo Administrador</button>
  </div>
  <div id="admin-buttons-wrapper" class="admin-buttons-centered hidden">
    <button id="user-mode-btn" class="button-style">Modo Usuário</button>
    <button id="selecionar-todas" class="admin-button button-style hidden">Selecionar Todas</button>
    <button id="deselecionar-todas" class="admin-button button-style hidden">Limpar Todas</button>
    <button id="criar-vaga" class="admin-button button-style hidden">Criar Vaga</button>
    <button id="apagar-vaga" class="admin-button button-style hidden">Apagar Vaga</button>
    <button id="mover-vaga" class="admin-button button-style hidden">Mover/Rotacionar</button>
  </div>
  
  <div style="position: relative; width: 100%; max-width: 900px;">
    <canvas id="renderCanvas"></canvas>
    <div id="loading-screen">Carregando modelo 3D...</div>
  </div>
  
  <div class="legenda">
    <div class="legenda-item">
      <div class="legenda-icon livre"></div>
      <span>Vaga Livre</span>
    </div>
    <div class="legenda-item">
      <div class="legenda-icon ocupada"></div>
      <span>Vaga Ocupada</span>
    </div>
    <div class="legenda-item">
      <div class="legenda-icon especial-livre"></div>
      <span>Vaga Especial Livre</span>
    </div>
    <div class="legenda-item">
      <div class="legenda-icon especial-ocupada"></div>
      <span>Vaga Especial Ocupada</span>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <!-- Babylon.js Scripts -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDvgoGXBnFZbXi28SuSnQlx8mIN6Ebsflk",
      authDomain: "estacionamentosmamus.firebaseapp.com",
      databaseURL: "https://estacionamentosmamus-default-rtdb.firebaseio.com",
      projectId: "estacionamentosmamus",
      storageBucket: "estacionamentosmamus.appspot.com",
      messagingSenderId: "864410096092",
      appId: "1:864410096092:web:c8f039da393d4130bb7f19",
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const vagasRef = database.ref('vagas');

    // DOM Elements
    const canvas = document.getElementById('renderCanvas');
    const contador = document.getElementById('contador');
    const adminAccessBtn = document.getElementById('admin-mode-btn');
    const adminButtonsWrapper = document.getElementById('admin-buttons-wrapper');
    const allAdminButtons = adminButtonsWrapper.querySelectorAll('button');
    const userModeBtn = document.getElementById('user-mode-btn');
    const loadingScreen = document.getElementById('loading-screen');

    // Variables
    let isAdminMode = false;
    let isMoveMode = false;
    let selectedAction = null;
    let vagas = [];
    const adminPassword = "admin123";

    // Babylon.js variables
    let engine, scene, camera, parkingModel;
    let vagaMeshes = new Map();
    let selectedVaga = null;

    // Initialize Babylon.js
    function initBabylon() {
      engine = new BABYLON.Engine(canvas, true);
      scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color3(0.2, 0.2, 0.3);

      // Camera
      camera = new BABYLON.ArcRotateCamera("camera", -Math.PI/2, Math.PI/3, 50, BABYLON.Vector3.Zero(), scene);
      camera.setTarget(BABYLON.Vector3.Zero());
      
      // Set as active camera and attach controls
      scene.activeCamera = camera;
      camera.attachControls(canvas, true);

      // Lighting
      const hemisphericLight = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
      hemisphericLight.intensity = 0.7;
      
      const directionalLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(-1, -1, -1), scene);
      directionalLight.position = new BABYLON.Vector3(20, 40, 20);
      directionalLight.intensity = 0.8;

      // Create basic scene first to ensure something renders
      console.log("Inicializando cenário básico...");
      createFallbackGround();

      // Then try to load the parking lot model
      loadParkingModel();

      // Start render loop
      engine.runRenderLoop(() => {
        scene.render();
      });

      // Handle resize
      window.addEventListener('resize', () => {
        engine.resize();
      });

      // Handle clicks
      scene.onPointerObservable.add((pointerInfo) => {
        if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERUP) {
          if (pointerInfo.pickInfo.hit) {
            const pickedMesh = pointerInfo.pickInfo.pickedMesh;
            if (pickedMesh && pickedMesh.userData && pickedMesh.userData.vagaId) {
              handleVagaClick(pickedMesh.userData.vagaId);
            }
          }
        }
      });
    }

    function loadParkingModel() {
      // Try to load your 3D model as an enhancement over the basic scene
      console.log("Tentando carregar modelo 3D...");
      
      BABYLON.SceneLoader.ImportMeshAsync("", "https://linckrafael.github.io/smamus3Dv5.0/", "parking.glb", scene)
        .then((result) => {
          console.log("Modelo carregado com sucesso!", result);
          parkingModel = result.meshes[0];
          if (parkingModel) {
            parkingModel.scaling = new BABYLON.Vector3(1, 1, 1);
            parkingModel.position = new BABYLON.Vector3(0, 0, 0);
            loadingScreen.textContent = "Modelo 3D carregado!";
          }
        })
        .catch((error) => {
          console.log("Modelo 3D não encontrado, usando cenário básico:", error);
          loadingScreen.textContent = "Usando cenário básico";
        })
        .finally(() => {
          // Always load vagas regardless of model loading success
          setTimeout(() => {
            loadVagasFromFirebase();
          }, 1000);
        });
    }

    function createFallbackGround() {
      console.log("Criando cenário básico...");
      loadingScreen.textContent = "Criando cenário básico...";
      
      // Create main ground
      const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 40, height: 30}, scene);
      const groundMaterial = new BABYLON.StandardMaterial("groundMat", scene);
      groundMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.3, 0.3);
      ground.material = groundMaterial;
      
      // Create some basic parking lot elements
      const building = BABYLON.MeshBuilder.CreateBox("building", {width: 10, height: 8, depth: 15}, scene);
      building.position = new BABYLON.Vector3(-15, 4, 0);
      const buildingMaterial = new BABYLON.StandardMaterial("buildingMat", scene);
      buildingMaterial.diffuseColor = new BABYLON.Color3(0.6, 0.6, 0.7);
      building.material = buildingMaterial;
      
      // Create parking lines
      for(let i = -15; i <= 15; i += 5) {
        const line = BABYLON.MeshBuilder.CreateBox("line", {width: 0.2, height: 0.1, depth: 25}, scene);
        line.position = new BABYLON.Vector3(i, 0.05, 0);
        const lineMaterial = new BABYLON.StandardMaterial("lineMat", scene);
        lineMaterial.diffuseColor = new BABYLON.Color3(1, 1, 1);
        line.material = lineMaterial;
      }
      
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        console.log("Cenário básico criado!");
      }, 1000);
    }

    function loadVagasFromFirebase() {
      vagasRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          vagas = Object.keys(data).map(key => ({ id: key, ...data[key] }));
        } else {
          vagas = [];
        }
        renderVagas3D();
      });
    }

    function renderVagas3D() {
      // Clear existing vaga meshes
      vagaMeshes.forEach(mesh => {
        mesh.dispose();
      });
      vagaMeshes.clear();

      // Create 3D vagas
      vagas.forEach(vaga => {
        createVaga3D(vaga);
      });

      atualizarContador();
    }

    function createVaga3D(vaga) {
      // Create a box for the parking space
      const vagaBox = BABYLON.MeshBuilder.CreateBox(vaga.id, {width: 2.5, height: 0.1, depth: 4}, scene);
      
      // Position based on the original 2D coordinates, converted to 3D space
      const x = (vaga.left - 50) * 0.4; // Convert percentage to 3D coordinates
      const z = (vaga.top - 50) * 0.3;
      vagaBox.position = new BABYLON.Vector3(x, 0.05, z);
      
      // Rotation
      vagaBox.rotation.y = BABYLON.Tools.ToRadians(vaga.rotate || 0);

      // Material based on status
      const material = new BABYLON.StandardMaterial(vaga.id + "_mat", scene);
      
      if (vaga.ocupada) {
        if (vaga.id === 'V15' || vaga.id === 'V16') {
          material.diffuseColor = new BABYLON.Color3(0.8, 0.8, 0.8); // Gray for police
        } else {
          material.diffuseColor = new BABYLON.Color3(0.8, 0, 0); // Red for occupied
        }
      } else {
        if (vaga.id === 'V15' || vaga.id === 'V16') {
          material.diffuseColor = new BABYLON.Color3(0, 0, 0.8); // Blue for special
        } else {
          material.diffuseColor = new BABYLON.Color3(0, 0.8, 0); // Green for free
        }
      }
      
      material.alpha = 0.7;
      vagaBox.material = material;

      // Add user data for identification
      vagaBox.userData = { vagaId: vaga.id };

      // Add text label
      if (!vaga.ocupada) {
        createVagaLabel(vaga, vagaBox.position);
      }

      // Store mesh reference
      vagaMeshes.set(vaga.id, vagaBox);

      // Add glow effect for admin mode
      if (isAdminMode) {
        vagaBox.renderOutline = true;
        vagaBox.outlineColor = new BABYLON.Color3(1, 1, 0);
        vagaBox.outlineWidth = 0.02;
      }
    }

    function createVagaLabel(vaga, position) {
      // Create a simple text plane (you might want to use a more sophisticated text system)
      const textPlane = BABYLON.MeshBuilder.CreatePlane(vaga.id + "_text", {width: 1, height: 0.5}, scene);
      textPlane.position = new BABYLON.Vector3(position.x, position.y + 0.2, position.z);
      textPlane.billboardMode = BABYLON.Mesh.BILLBOARDMODE_Y;
      
      const textMaterial = new BABYLON.StandardMaterial(vaga.id + "_textMat", scene);
      textMaterial.diffuseColor = new BABYLON.Color3(1, 1, 1);
      textMaterial.emissiveColor = new BABYLON.Color3(0.2, 0.2, 0.2);
      textPlane.material = textMaterial;

      // Store with the main mesh
      if (vagaMeshes.has(vaga.id)) {
        const mainMesh = vagaMeshes.get(vaga.id);
        textPlane.parent = mainMesh;
      }
    }

    function handleVagaClick(vagaId) {
      const vaga = vagas.find(v => v.id === vagaId);
      if (!vaga) return;

      if (isAdminMode) {
        if (selectedAction === 'delete') {
          vagasRef.child(vagaId).remove();
          selectedAction = null;
        } else if (isMoveMode) {
          // Handle move mode - you can implement drag functionality here
          selectedVaga = selectedVaga === vagaId ? null : vagaId;
          console.log("Vaga selecionada para mover:", selectedVaga);
        } else {
          vagasRef.child(vagaId).update({ ocupada: !vaga.ocupada });
        }
      }
    }

    function atualizarContador() {
      const total = vagas.length;
      const ocupadas = vagas.filter(v => v.ocupada).length;
      contador.textContent = `Total: ${total} | Ocupadas: ${ocupadas} | Livres: ${total - ocupadas}`;
    }

    // Admin functions (keeping original logic)
    function toggleAdminButtonsWrapper(show) {
      if (show) adminButtonsWrapper.classList.remove('hidden');
      else adminButtonsWrapper.classList.add('hidden');
    }

    function toggleIndividualAdminButtons(show) {
      allAdminButtons.forEach(button => {
        if (button.id === 'user-mode-btn') {
          button.classList.remove('hidden');
        } else {
          show ? button.classList.remove('hidden') : button.classList.add('hidden');
        }
      });
    }

    // Event Listeners
    adminAccessBtn.addEventListener('click', () => {
      const senha = prompt("Digite a senha do administrador:");
      if (senha === adminPassword) {
        isAdminMode = true;
        alert("Modo Administrador ativado.");
        adminAccessBtn.classList.add('hidden');
        toggleAdminButtonsWrapper(true);
        toggleIndividualAdminButtons(true);
        renderVagas3D();
      } else {
        alert("Senha incorreta!");
      }
    });

    userModeBtn.addEventListener('click', () => {
      isAdminMode = false;
      isMoveMode = false;
      selectedAction = null;
      selectedVaga = null;
      adminAccessBtn.classList.remove('hidden');
      toggleAdminButtonsWrapper(false);
      toggleIndividualAdminButtons(false);
      renderVagas3D();
    });

    document.getElementById('selecionar-todas').addEventListener('click', () => {
      if (!isAdminMode) return;
      vagas.forEach(v => vagasRef.child(v.id).update({ ocupada: true }));
    });

    document.getElementById('deselecionar-todas').addEventListener('click', () => {
      if (!isAdminMode) return;
      vagas.forEach(v => vagasRef.child(v.id).update({ ocupada: false }));
    });

    document.getElementById('criar-vaga').addEventListener('click', () => {
      if (!isAdminMode) return;
      const novaId = prompt('ID da nova vaga:');
      if (!novaId) return;
      vagasRef.child(novaId).set({ 
        top: Math.random() * 80 + 10, 
        left: Math.random() * 80 + 10, 
        rotate: 0, 
        ocupada: false 
      });
    });

    document.getElementById('apagar-vaga').addEventListener('click', () => {
      if (!isAdminMode) return;
      selectedAction = 'delete';
      alert('Clique na vaga que deseja apagar.');
    });

    document.getElementById('mover-vaga').addEventListener('click', () => {
      if (!isAdminMode) return;
      isMoveMode = !isMoveMode;
      selectedVaga = null;
      alert(isMoveMode ? 
        'Modo mover/rotacionar ativado. Clique em uma vaga para selecioná-la.' : 
        'Modo mover/rotacionar desativado.');
      renderVagas3D();
    });

    // Initialize
    toggleAdminButtonsWrapper(false);
    adminAccessBtn.classList.remove('hidden');
    initBabylon();
  </script>
</body>
</html>
